{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="main-container">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="container">
                <h1 class="hero-title">
                    <i class="fas fa-brain me-3"></i>EduRAG
                </h1>
                <p class="hero-subtitle">
                    AI-Powered NCERT Question Answering System
                </p>
                <div class="status-indicator">
                    {% if status.initialized %}
                        <span class="status-badge status-ready">
                            <i class="fas fa-check-circle me-1"></i>System Ready
                        </span>
                    {% elif status.error %}
                        <span class="status-badge status-error">
                            <i class="fas fa-exclamation-triangle me-1"></i>System Error
                        </span>
                    {% else %}
                        <span class="status-badge status-loading">
                            <i class="fas fa-cog fa-spin me-1"></i>Initializing
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container py-5">
            <div class="row">
                <!-- Chat Interface -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-comments me-2"></i>Ask Questions About Your NCERT Content
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="chat-container" class="chat-container">
                                <div class="message message-bot">
                                    <div class="d-flex align-items-start">
                                        <div class="avatar me-3">
                                            <i class="fas fa-robot fa-2x text-primary"></i>
                                        </div>
                                        <div>
                                            <strong>EduRAG Assistant</strong>
                                            <p class="mb-0 mt-2">
                                                Hello! I'm your NCERT AI assistant. Ask me any questions about your uploaded educational content.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Query Form -->
                            <form id="query-form" class="mt-3">
                                <div class="input-group">
                                    <input type="text" 
                                           id="question-input" 
                                           class="form-control" 
                                           placeholder="Type your question here..." 
                                           {% if not status.initialized %}disabled{% endif %}>
                                    <button type="submit" 
                                            class="btn btn-primary" 
                                            id="submit-btn"
                                            {% if not status.initialized %}disabled{% endif %}>
                                        <span class="btn-text">
                                            <i class="fas fa-paper-plane me-1"></i>Ask
                                        </span>
                                        <span class="loading">
                                            <span class="spinner-border spinner-border-sm me-1"></span>Thinking...
                                        </span>
                                    </button>
                                </div>
                            </form>

                            {% if status.error %}
                            <div class="alert alert-danger mt-3">
                                <strong>Error:</strong> {{ status.error }}
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="reinitializeSystem()">
                                    <i class="fas fa-redo me-1"></i>Retry
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- System Status -->
                    <div class="stats-card">
                        <div class="stats-number">{{ status.pdf_count }}</div>
                        <div class="stats-label">PDF Files Loaded</div>
                    </div>

                    <div class="stats-card">
                        <div class="stats-number">
                            {% if status.vectorstore_ready %}
                                <i class="fas fa-check-circle text-success"></i>
                            {% else %}
                                <i class="fas fa-times-circle text-danger"></i>
                            {% endif %}
                        </div>
                        <div class="stats-label">Vector Database</div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <h6 class="mb-0">Quick Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/upload" class="btn btn-outline-primary">
                                    <i class="fas fa-upload me-1"></i>Upload PDFs
                                </a>
                                <button class="btn btn-outline-secondary" onclick="refreshStatus()">
                                    <i class="fas fa-sync me-1"></i>Refresh Status
                                </button>
                                <button class="btn btn-outline-warning" onclick="reinitializeSystem()">
                                    <i class="fas fa-redo me-1"></i>Reinitialize System
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Sample Questions -->
                    <div class="card border-0 shadow-sm mt-3">
                        <div class="card-header bg-white border-0">
                            <h6 class="mb-0">Sample Questions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-info sample-question" 
                                        data-question="What is photosynthesis?">
                                    What is photosynthesis?
                                </button>
                                <button class="btn btn-sm btn-outline-info sample-question" 
                                        data-question="Explain the structure of an atom">
                                    Explain the structure of an atom
                                </button>
                                <button class="btn btn-sm btn-outline-info sample-question" 
                                        data-question="What are the different types of government?">
                                    What are the different types of government?
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Handle form submission
    $('#query-form').on('submit', function(e) {
        e.preventDefault();
        
        const question = $('#question-input').val().trim();
        if (!question) return;
        
        // Add user message to chat
        addMessage(question, 'user');
        
        // Clear input and show loading
        $('#question-input').val('');
        showLoading(true);
        
        // Send query to API
        $.ajax({
            url: '/api/query',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ question: question }),
            success: function(response) {
                if (response.success) {
                    addMessage(response.answer, 'bot', response.processing_time);
                } else {
                    addMessage('Sorry, I encountered an error: ' + response.error, 'bot');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error occurred';
                addMessage('Sorry, I encountered an error: ' + error, 'bot');
            },
            complete: function() {
                showLoading(false);
            }
        });
    });
    
    // Handle sample questions
    $('.sample-question').on('click', function() {
        const question = $(this).data('question');
        $('#question-input').val(question);
        $('#query-form').submit();
    });
});

function addMessage(content, sender, processingTime = null) {
    const chatContainer = $('#chat-container');
    const messageClass = sender === 'user' ? 'message-user' : 'message-bot';
    const avatar = sender === 'user' ? 
        '<i class="fas fa-user fa-2x text-white"></i>' : 
        '<i class="fas fa-robot fa-2x text-primary"></i>';
    
    const timeInfo = processingTime ? 
        `<small class="text-muted">Processed in ${processingTime}s</small>` : '';
    
    const messageHtml = `
        <div class="message ${messageClass}">
            <div class="d-flex align-items-start">
                <div class="avatar me-3">${avatar}</div>
                <div>
                    <strong>${sender === 'user' ? 'You' : 'EduRAG Assistant'}</strong>
                    <p class="mb-0 mt-2">${content}</p>
                    ${timeInfo}
                </div>
            </div>
        </div>
    `;
    
    chatContainer.append(messageHtml);
    chatContainer.scrollTop(chatContainer[0].scrollHeight);
}

function showLoading(show) {
    const submitBtn = $('#submit-btn');
    const btnText = submitBtn.find('.btn-text');
    const loading = submitBtn.find('.loading');
    
    if (show) {
        btnText.hide();
        loading.show();
        submitBtn.prop('disabled', true);
        $('#question-input').prop('disabled', true);
    } else {
        btnText.show();
        loading.hide();
        submitBtn.prop('disabled', false);
        $('#question-input').prop('disabled', false);
        $('#question-input').focus();
    }
}

function refreshStatus() {
    $.get('/api/status', function(status) {
        location.reload();
    });
}

function reinitializeSystem() {
    if (confirm('This will reinitialize the entire system. Continue?')) {
        $.post('/api/reinitialize', function(response) {
            if (response.success) {
                alert('System reinitialized successfully!');
                location.reload();
            } else {
                alert('Failed to reinitialize system. Check the logs.');
            }
        });
    }
}
</script>
{% endblock %}